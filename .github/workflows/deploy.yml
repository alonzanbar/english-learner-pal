# Deploy web app to Firebase Hosting (staging or prod).
# API calls use relative /api/*; Hosting rewrites them to Cloud Run (no CORS, no BACKEND_URL_* needed).
#
# Required secret: FIREBASE_TOKEN
#   Get it: npx firebase login:ci
#   Add: repo Settings → Secrets and variables → Actions → New repository secret
#
# Optional variable: GCP_REGION (default us-central1) — must match Cloud Run region for /api/** rewrite.
#
# Triggers:
#   - Push to main → deploy to staging
#   - Manual run → choose staging or prod
#   - Release published → deploy to prod

name: Deploy to Firebase Hosting

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
  release:
    types: [published]

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set deploy environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies and build
        run: |
          cd apps/web
          npm ci
          npm run build

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Generate firebase.json with API rewrite
        run: |
          node -e "
          const env = process.env.DEPLOY_ENV;
          const region = process.env.GCP_REGION;
          const config = {
            hosting: {
              public: 'apps/web/dist',
              ignore: ['firebase.json', '**/.*', '**/node_modules/**'],
              rewrites: [
                { source: '/api/**', run: { serviceId: 'wordlist-backend-' + env, region } },
                { source: '**', destination: '/index.html' }
              ]
            }
          };
          require('fs').writeFileSync('firebase.json', JSON.stringify(config, null, 2));
          console.log('firebase.json: /api/** -> Cloud Run wordlist-backend-' + env + ' (' + region + ')');
          "
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}

      - name: Deploy to Firebase Hosting
        run: |
          firebase use ${{ steps.env.outputs.environment }}
          firebase deploy --only hosting --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
