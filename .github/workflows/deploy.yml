# Deploy web app to Firebase Hosting (staging or prod).
#
# Required secret: FIREBASE_TOKEN
#   Get it: npx firebase login:ci
#   Add: repo Settings → Secrets and variables → Actions → New repository secret
#
# Triggers:
#   - Push to main → deploy to staging
#   - Manual run → choose staging or prod
#   - Release published → deploy to prod

name: Deploy to Firebase Hosting

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
  release:
    types: [published]

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set deploy environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Set backend URL for build
        id: api_url
        run: |
          if [[ "${{ steps.env.outputs.environment }}" == "staging" ]]; then
            echo "url=${{ vars.BACKEND_URL_STAGING }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ vars.BACKEND_URL_PROD }}" >> $GITHUB_OUTPUT
          fi

      - name: Require backend URL (Firebase app must call Cloud Run)
        run: |
          URL="${{ steps.api_url.outputs.url }}"
          if [[ -z "$URL" ]]; then
            echo "::error::Set repo variable BACKEND_URL_STAGING (and BACKEND_URL_PROD for prod). See README."
            exit 1
          fi
          echo "Building with VITE_API_URL=$URL"

      - name: Install dependencies and build
        run: |
          cd apps/web
          npm ci
          npm run build
        env:
          VITE_API_URL: ${{ steps.api_url.outputs.url }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting
        run: |
          firebase use ${{ steps.env.outputs.environment }}
          firebase deploy --only hosting --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
